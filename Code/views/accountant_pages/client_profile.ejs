<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <!-- fontawesome for icons -->
    <script src="https://kit.fontawesome.com/d2c306d566.js" crossorigin="anonymous"></script>
    <!--ajax-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <!--CSS-->
    <link rel="stylesheet" href="general_css.css">
    <link rel="stylesheet" href="clients_profile_css.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%- include('../partials/header'); %>
</head>
<body>

    <div id="general-client-info" name="general-client-info">
        <h2><%= selected_client.name %></h2>
        <div class="badge">
            <img src="<%= selected_client.logo %>" id="company_logo">
            <h3> <%= selected_client.name %></h3>
        </div>
        <button id="create_page">+</button>

    </div>

    <div id="client-transactions-div" name="client-transactions-div">
        <h2>Client Transactions</h2>
        <ul>
            <li>Transaction 1</li>
            <li>Transaction 2</li>
        </ul>
    </div>

    <div id="client-assignments-div" name="client-assignments-div">
        <h2>Client Requests</h2>
        <div id="my_requests_div">
            <table id="clients_requests_record">
                <tr> <!-- This is a table row -->
                    <th>Type</th> <!-- Table header cell -->
                    <th>Title</th>
                    <th>RegistrationDate</th>
                    <th>Status</th>
                    <th> </th>
                </tr>
            </table>
            <form style="display: none;" action="/my-accountant-delete-request" method="POST" id="delete_request_from">
                <input name="request_id" id="request_id">
                <button id="submit_from_delete_request_btn" type="submit">Submit</button>
            </form>
        </div>
        <a href="">Client Assignment History</a>
    </div>

    <div id="client-messaging-div" name="client-messaging-div">
        <h2>Client Messaging</h2>
        <h3>Messaging will happen here</h3>
    </div>

    <button id="remove-client-button" name="remove-client-button">Remove Client</button>
    <a href="/report/user?id=<%=selected_client._id%>">Report Client</a>

    <div id="client-rating-div" name="client-rating-div">
        <h2>Rating Client</h2>
         <form class="rating_form" action="/client-profile" method="POST">
            <input style="display: none;" type="text" name='clients_id' value="<%= selected_client._id %>">
            <button type="button" class="star_btn"><i class="fa-solid fa-star"></i></button>
            <button type="button" class="star_btn"><i class="fa-solid fa-star"></i></button>
            <button type="button" class="star_btn"><i class="fa-solid fa-star"></i></button>
            <button type="button" class="star_btn"><i class="fa-solid fa-star"></i></button>
            <button type="button" class="star_btn"><i class="fa-solid fa-star"></i></button>
            <br>
            <input style="display: none;" type="text" id='rating_input' name='rating_input'>
            <br>
            <textarea id='rating_textarea' name='rating_textarea'></textarea>
            <br>
            <button type="submit">Submit</button>
        </form>
    </div>
    <button id="back_btn">Πίσω</button>
</body>
<script>
    $(document).ready(function(){
        const timestamp_options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };

        $("#back_btn").click(function(){
            window.location = "/clients"
        });

        $("#create_page").click(function(){
            window.location = "/create"
        });

        var starButtons = $(".star_btn");
        for (var i = 0; i < starButtons.length; i++) {
            (function(index) {
                $(starButtons[i]).click(function() {
                    var rating_value = index+1
                    if($("#rating_input").val() == index+1){
                        rating_value = 0;
                    }
                    $("#rating_input").val(rating_value);
                    for (var j = 0; j < starButtons.length; j++) {
                        if(j < rating_value){
                            starButtons[j].classList.add("star_selected");
                        }
                        else{
                            if (starButtons[j].classList.contains("star_selected")) {
                                starButtons[j].classList.remove("star_selected");
                            }
                        }
                    }

                });
            })(i);
        }
        if('<%= review.rating%>'!='-1'){
            $("#rating_textarea").val('<%= review.text%>');
            starButtons[parseInt('<%= review.rating%>')-1].click()
        }

        var requests;
        try {
            requests = JSON.parse(`<%- JSON.stringify(clients_requests) %>`);
        } catch (error) {
            console.error("Error parsing JSON:", error);
        }

        const requests_table = $("#clients_requests_record");
        if(requests.length == 0){
            requests_table.hide()
            $("#my_requests_div").append($("<p>").text("The Client haven't made any requests addressed you"))
        }
        else{
            requests.forEach(request => {
                const row = $("<tr>");
                const cell_type = $("<td>").text(request.type);
                const cell_title = $("<td>").text(request.title);
                const date = new Date(request.registrationDate);
                const cell_reg_date = $("<td>").text(date.toLocaleString('en-US', timestamp_options));
                const cell_status = $("<td>").text(request.status);
                const cell_actions = $("<td>");
                const btn_delete = $("<button>").text("Delete");
                btn_delete.click(function() {
                    $("#request_id").val(request._id)
                    $("#submit_from_delete_request_btn").click()
                });
                
                requests_table.append(row);
                row.append(cell_type);
                row.append(cell_title);
                row.append(cell_reg_date);
                row.append(cell_status);
                row.append(cell_actions);
                cell_actions.append(btn_delete);
            });
        }        
    });
</script>
<%- include('../partials/footer'); %>
</html>