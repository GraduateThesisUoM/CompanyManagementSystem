<!DOCTYPE html>
<html lang="en">
    <head>
        <title>PayRoll</title>
        <!-- fontawesome for icons -->
        <script src="https://kit.fontawesome.com/d2c306d566.js" crossorigin="anonymous"></script>
        <!--ajax-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <!--CSS-->
        <link rel="stylesheet" href="general_css.css">
        <link rel="stylesheet" href="my_select_css.css">
        <link rel="stylesheet" href="fonts_css.css">
        <link rel="stylesheet" href="table_css.css">
        <link rel="stylesheet" href="buttons_css.css">
        <link rel="stylesheet" href="textarea_css.css">

        <!--Fonts-->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Asap+Condensed:wght@400;700&display=swap" rel="stylesheet" />
        <!--Charts-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/0.7.0/chartjs-plugin-datalabels.min.js"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

        <script src="JSFrontEndFunctions.js"></script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <%- include('../partials/header'); %>
    </head>
    <style>
        #client_select,#person_select{
            width: calc(100% - 30px);
            padding: 5px 15px;
            border-radius: 10px;
            color:white
        }
        #filter_container{
            margin-right: 30px;
            font-size: 1.1em;
        }

        #chart_container{
            /* From https://css.glass */
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);

            margin-right: 30px;
            margin-top: 30px;
            padding-top: 30px;
        }

        #chart_container canvas{
            padding-top: 30px;

        }
        #table_container{
            margin: 30px 0px;
        }
        .my_select{
            padding: 5px 10px;
            border-radius: 10px;
        }
    </style>
    <body>
        <div class="has_sidebar">
            <%- include('../partials/sidebar'); %>
            <div>
                <div class="asap-condensed-regular">
                    <h1>PayRoll</h1>
                    <div class="glass_effect_2 container" id="filter_container">
                        <form action="/payroll" method="POST">
                            <div id="time_gap">
                                <label for="year">Year</label>
                                <select class="my_select" id="year" id="year">
                                    <% for(let i=2020; i<2100; i++){ %>
                                        <option value="<%= i %>"><%= i %></option>
                                    <% } %>                                
                                </select>
                                <label for="from_month">From</label>
                                <select class="my_select" id="from_month" id="from_month">
                                    <% for(let i=1; i<13; i++){ %>
                                        <option value="<%= i %>"><%= i %></option>
                                    <% } %>                                 
                                </select>
                                <label for="to_month">To</label>
                                <select class="my_select" name="to_month" id="to_month">
                                    <% for(let i=1; i<13; i++){ %>
                                        <option value="<%= i %>"><%= i %></option>
                                    <% } %>                                 
                                </select>
                            </div>
                            
                            <label for="client_select">Client</label>
                            <select class="my_select" id="client_select" name="client_select">
                                <% for(c of clients){%>
                                    <option value="<%= c._id%>"><%= c.name%></option>
                                <% }%>

                            </select>
                            <label for="person_select">Person</label>
                            <select class="my_select" id="person_select" name="person_select">
                                <% for(c of clients_users){%>
                                    <option class="<%=c.c.company%> user" value="<%= c.u._id%>"><%= c.u.firstName %> <%= c.u.lastName %></option>
                                <% }%>
                            </select>
                            <div id="persons_data">
                                <p> First Name : <%=selected_user.firstName%></p>
                                <p> Last Name : <%=selected_user.lastName%></p>
                                <p> Time In the Company : <br>
                                    Years  : <%=time_in_comp.years%><br>
                                    Months : <%=time_in_comp.months%><br>
                                    Days   : <%=time_in_comp.days%></p>
                            </div>
                            <div id="salary_data_cont">
                                <div>
                                    Full Salary : <span id="fullsalry">0</span>
                                </div>
                                <div>
                                    Christmas Gift : <span id="christmasgift">0</span>
                                </div>
                                <div>
                                    Leave Pay: <span id="leavepay">0</span>
                                </div>
                                <div>
                                    Leave Allowance: <span id="leaveallowance">0</span>
                                </div>
                                <div>
                                    Overtime: <span id="overtime">0</span>
                                </div>
                                <div>
                                    €/hour: <span id="hourpay">0</span>
                                </div>
                                <div>
                                    Employer Contributions: <span id="employercontributions">0</span>
                                </div>
                                <div>
                                    Employee Contributions: <span id="employeecontributions">0</span>
                                </div>
                            </div>
                            <div id="set_salary_cont">
                                <div>
                                    <input name="salary" id="salary" type="number" step="0.01" value="<%=salary%>">
                                    <lable for="salary">€</lable>
                                </div>
                                <button class="button_3">Set</button>
                            </div>
                       </form>
                    </div>
                    <div id="chart_container" class="glass_effect_2" style="width: 95%;">
                        <div id="line_chart_div" style="width: 100%; height: 500px;"></div>

                    </div>
                    <br>
                    <div style="width: 95%; display: flex;justify-content: space-between;gap:50%">
                        <input type="date" id="from_date" class="date_filters input_type_1"/>
                        <input type="date" id="to_date" class="date_filters input_type_1"/>
                    </div>
                    <div class="table_container" id="table_container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Day</th>
                                    <th>Clock In</th>
                                    <th>Clock Out</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for(a of attendance){%>
                                    <tr class="glass_effect_2">
                                        <th><%=a.month%></th>
                                        <th><%=a.day%></th>
                                        <th><%=a.clock_in%></th>
                                        <th><%=a.clock_out%></th>
                                    </tr>
                                <%}%>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>

       $(document).ready(function(){
            const queryString = new URL(window.location.href).search;
            var params = new URLSearchParams(queryString);
            if(params.get('comp')){
                $("#client_select").val(params.get('comp'))
            }
            if(params.get('id')){
                $("#person_select").val(params.get('id'))
            }
            if (params.get('year')){
                $("#year").val(params.get('year'))
            }
            else{
                $("#year").val(new Date().getFullYear())
            }
            if (params.get('from_month')){
                $("#from_month").val(params.get('from_month'))
            }
            else{
                $("#from_month").val(new Date().getMonth() + 1) 
            }
            if (params.get('to_month')){
                $("#to_month").val(params.get('to_month'))
            }
            else{
                $("#to_month").val(new Date().getMonth() + 1) 
            }
            if($("#to_month").val() < $("#from_month").val()){
                $("#to_month").val($("#from_month").val());
            }
            
            
            $("#client_select").change(function(){
                window.location = '/payroll?comp='+$("#client_select").val()
            })


            $("#person_select").change(function(){
                window.location = '/payroll?id='+$("#person_select").val()+'&comp='+$("#client_select").val()
            })

            $(".my_select").change(function(){
                var from_month = $("#from_month").val();
                var to_month = $("#to_month").val()
                if(to_month < from_month){
                    to_month = from_month;
                }
                window.location = '/payroll?id='+$("#person_select").val()+
                '&comp='+$("#client_select").val()+
                "&year="+$("#year").val()+
                "&from_month="+from_month+
                "&to_month="+to_month
            })
            

            const payroll_months = JSON.parse(`<%- JSON.stringify(payroll_months) %>`);
            const payroll_amounts = JSON.parse(`<%- JSON.stringify(payroll_amounts) %>`);

            
            const today = new Date();
            const formattedToday = `${today.getDate().toString().padStart(2, '0')}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getFullYear()}`;

            drawLineChart(payroll_months, payroll_amounts);

            function drawLineChart(xData, lineData,name) {
                google.charts.load('current', {'packages':['corechart']});
                google.charts.setOnLoadCallback(function() {
                    var data = new google.visualization.DataTable();
                    data.addColumn('string', 'Month');  // X-axis
                    data.addColumn('number', 'Salary');  // Line data
            
                    for (var i = 0; i < xData.length; i++) {
                        data.addRow([xData[i], lineData[i]]);
                    }

                    var minAmount = Math.min(...lineData) - 10;  // Calculate the minimum of payroll_amounts
                    var maxAmount = Math.max(...lineData) + 10;  // Calculate the max and add 10
        
                    var options = {
                        hAxis: {
                            slantedTextAngle: 0,  // Angle for slanted text
                            minValue: 0,  // Start point for ticks (first label)
                            ticks: xData,  // Horizontal axis labels
                            textStyle: { color: 'black' }  // Color of the text labels

                        },
                        vAxis: {
                            minValue: minAmount,
                            maxValue: maxAmount,
                            textStyle: { color: 'black' } ,
                            gridlines: { count: 6 } 
                        },
                        lineWidth: 4,
                        pointSize: 4,
                        backgroundColor: 'transparent',
                        lineTension: 0.2,
                        pointSize: 6,  // Adjust point size for better visibility
                        tooltip: { isHtml: true },  // Enable tooltip for points
                        series: {
                            0: {
                                pointLabelFontSize: 10,
                                pointLabelOffset: 15,  // Offset from the point
                                pointLabel: { show: true, color: '#12357E' },
                                color: '#12357E' 
                            }
                        },
                        legend: { position: 'none' }
                    };

                    var chart = new google.visualization.LineChart(document.getElementById('line_chart_div'));
                    chart.draw(data, options);
                });
            }

            calculateSalary()

            $(".date_filters").change(function(event){
                event.preventDefault();
                var from_date = $("#from_date").val();
                var to_date = $("#to_date").val();
                window.location = "/payroll?from_date="+from_date+"&to_date="+to_date;
            });



            function calculateSalary(salary) {
                var fullSalary = $("#salary").val();
                var christmasGift = 300;
                var leavePay = 200;
                var leaveAllowance = 100;
                
                var overtimeHours = 4;
                var hourPay = 4;
                var netSalary = fullSalary + christmasGift + leavePay + leaveAllowance + (overtimeHours * hourPay);
                
                var employerContributions = fullSalary * 0.2; // Example calculation, could vary based on your requirements
                var employeeContributions = fullSalary * 0.3; // Example calculation, could vary
                
                $("#fullsalry").html(fullSalary);
                $("#christmasgift").html(christmasGift);
                $("#leavepay").html(leavePay);
                $("#leaveallowance").html(leaveAllowance);
                $("#overtime").html(overtimeHours);
                $("#hourpay").html(hourPay);
                $("#netsalary").html(netSalary);
                $("#employercontributions").html(employerContributions);
                $("#employeecontributions").html(employeeContributions);
            }



        });

    </script>

</html>