<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doc</title>
    <!--ajax-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <!--CSS-->
    <link rel="stylesheet" href="general_css.css" />
    <link rel="stylesheet" href="create_doc_css.css" />
    <link rel="stylesheet" href="table_css.css" />
    <link rel="stylesheet" href="buttons_css.css" />
    <link rel="stylesheet" href="my_scrollbar_css.css" />

    <!--Fonts-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Asap+Condensed:wght@400;700&display=swap" rel="stylesheet" />

    <!--Header-->
    <%- include('../partials/header'); %>
  </head>

  <body>
    <div class="has_sidebar asap-condensed-extralight">
      <%- include('../partials/sidebar'); %>
      <div>
        <h1 id="list_header"><%=doc_name%></h1>
        <form action="/edit-doc" method="POST" id="create_doc_form">
          <input name="doc_id" value="<%=doc._id%>" style="display: none;">
          <input name="type2" value="<%=doc.type%>" style="display: none;">
          <div id="doc_data" class="glass_effect_2">
            <div>
              <div>
                <label for="doc_date">Date : </label>
                <input type="date" id="doc_date" name="doc_date" class="my_input" required value="<%=registrationDate%>"/>
              </div>
              <div class="customer_div">
                <label for="customer_id"><%=person_type%></label>
                <select name="customer_id" id="customer_id" class="my_input">
                  <% if (persons.length > 1) { %>
                  <option value="0">-</option>
                  <% } %> <% persons.forEach(function(person) { %>
                  <option value="<%= person._id %>"><%= person.name %></option>
                  <% }); %>
                </select>
              </div>
              <div class="warehouse_div">
                <label for="warehouse_id">Warehouse</label>
                <select name="warehouse_id" id="warehouse_id" class="my_input">
                  <option value="0">-</option>
                  <% warehouses.forEach(function(warehouse) { %>
                  <option value="<%= warehouse.id %>"><%= warehouse.title %></option>
                  <% }); %>
                </select>
              </div>
              <div>
                <label class="wholesale_retail" for="wholesale_retail">Type : </label>
                <select class="wholesale_retail my_input" id="wholesale_retail" name="wholesale_retail">
                  <option value="0">wholesale</option>
                  <option value="1">Retale</option>
                </select>
              </div>
              <div>
                <label for="doc_series">Series : </label>
                <select id="doc_series" name="doc_series" class="my_input">
                  <% if (series_list.length > 1) { %>
                  <option value="0">-</option>
                  <% } %> <% series_list.forEach(function(s) { %>
                  <option value="<%= s._id %>"><%= s.acronym %> - <%= s.title %></option>
                  <% }); %>
                </select>
              </div>
              <div>
                <label for="general_discount_amount">Discount : </label>
                <span>
                  <span style="display: grid; grid-template-columns: 65% 25%">
                    <input id="general_discount_amount" class="general_discount my_input" name="general_discount_amount" type="number" value="0" min="0" required />
                    <span>€</span>
                  </span>
                  <span style="display: grid; grid-template-columns: 65% 25%">
                    <input id="general_discount" class="general_discount my_input" name="general_discount" type="number" value="0" min="0" max="100" required />
                    <span style="text-indent: 5px"><strong>%</strong></span>

                  </span>
                </span>
              </div>
            </div>

            <div>
              <div>
                <label for="doc_total_value">Total Value : </label>
                <span>
                  <span id="doc_total_value">0.00</span>
                  <span >€</span>
                </span>
              </div>
              
              <div>
                <span>Total Cost : </span>
                <span><span id="doc_total_cost">0.00</span><span>€</span></span>
              </div>

              <div>
                <span>Total Discounts : </span>
                <span><span id="doc_total_disc">0.00</span><span>€</span></span>
              </div>
              <div>
                <span>Total after Discounts : </span>
                <span><span id="doc_total_after_disc">0.00</span><span>€</span></span>
              </div>
              <div>
                <span>Total after Tax : </span>
                <span><span id="doc_total_after_tax">0.00</span><span>€</span></span>
              </div>
            </div>

            <input type="text" id="doc_type" name="doc_type" style="display: none" />
            <input id="num_of_rows" name="num_of_rows" style="display: none" />
          </div>
          <div class="table_container no_scale">
            <table id="doc_table" class="my_table">
              <thead>
                <tr>
                  <th>A/A</th>
                  <th>Title</th>
                  <th>Qty</th>
                  <th>Tax</th>
                  <th>Discount</th>
                  <th>Discount %</th>
                  <th>U/P</th>
                  <th>Value</th>
                  <th>Price After Discount</th>
                  <th>Final Price</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </form>
        <div style="display: grid;grid-template-columns: 30% 30% 30%;gap:5%;margin-top: 20px;width:80%;margin-left:10%">
          <button class="button_2">Delete</button>
          <button id="transforms_btn" class="button_1">Transform</button>
          <button id="save_btn" class="button_3">Save</button>
        </div>
        <div id="transforms_to_div" class="asap-condensed-regular" style="display: none;">
          <div id="transforms_to_div_header">
            <img id="close_transforms_to_div" src="x.svg"/>
          </div>
          <div id="transforms_to_div_main" class="my_scrollbar">
            <form id="transform_doc" action="/transfrom-doc" method="POST" >
              <input id="transforms_to_div_main_input" name="series_to" type="text" style="display: none;">
              <input type="text" name="doc_id" value="<%= doc._id%>" style="display: none;">
              <input type="text" name="url" id="url" style="display: none;">
            </form>
          <% for(s of transforms_to){%>
            <button class="transforms_to_btn" id="<%= s._id%>"><%= s.name%></button>
          <%}%>
          </div>
        </div>
        <div id = history_container class="my_scrollbar">
          <% for (h of history){%>
            <div class="doc_history_point">
              <div class="history_container_reg_date"><%=h.registrationDate%></div>
              <div id="<%=h._id%>" class="doc_history_point_doc_data">
                <div><%=h.name%></div>
                <div><%=h.user%></div>
              </div>
            </div>
          <%}%>
        </div>
      </div>
    </div>
  </body>

  <script type="text/javascript" src="JSDocumentFunctions.js"></script>
  <script>
    $(document).ready(function () {
      //$("#transforms_to_div").hide();
      const params = new URLSearchParams(window.location.search);
      $("#url").val(window.location.pathname + window.location.search)
      

      var selected_items = JSON.parse(`<%- JSON.stringify(doc.invoiceData) %>`);
      var items = JSON.parse(`<%- JSON.stringify(items) %>`);
      var doc = JSON.parse(`<%- JSON.stringify(doc) %>`);


      // Loop through each ".doc_history_point_doc_data" element
      $(".doc_history_point_doc_data").each(function () {
        const parentElement = $(this).parent();
        
        // Check if the current element's ID matches the target doc._id
        if ($(this).attr("id") === doc._id) {
          // Add the desired class to the parent
          $(this).addClass("glass_effect_2");
          parentElement.addClass("current_doc");

          // Scroll to center the current document
          $("#history_container")[0].scrollTo({
            left:
              this.offsetLeft -
              $("#history_container").width() / 2 +
              $(this).outerWidth() / 2,
            behavior: "smooth",
          });
        } else {
          // Add the default class to other parents
          $(this).addClass("glass_effect_1");
        }
      });



      $("#doc_series").val(doc.series);
      $("#customer_id").val(doc.receiver)
      $("#warehouse_id").val(doc.warehouse)

      addNewRow(0, items);

      for (i in selected_items) {
        console.log(items)
        $(".doc_line_select:eq(" + i + ') option[value="' + selected_items[i].lineItem + '"]').prop("selected", true);
        
        put_data_on_row(i, items);
        let quantity = selected_items[i].quantity;
        let price_of_unit = selected_items[i].price_of_unit;
        let total = quantity * price_of_unit;
        let tax = selected_items[i].tax;
        let totalAfterTax = total + total * (tax / 100);
        let discount = selected_items[i].discount;
        let discount_p = ((discount / total) * 100).toFixed(2);

        //$("#quantity_" + i).val(quantity);
        //$("#tax_" + i).val(tax);
        //$("#discount_" + i).val(discount);
        //$("#discount_p_" + i).val(discount_p);
        //$("#price_of_unit_" + i).val(price_of_unit);
        //$("#total_price_of_line_" + i).text(total);
        //$("#total_price_of_line_after_disc_" + i).text(total - discount);
        //$("#final_price_of_line_" + i).text(total - discount + (total - discount) * (tax / 100));

        $(".remove_row").eq(i).prop("disabled", false);

        $("#quantity_" + i).css("visibility", "visible");
        $("#tax_" + i).css("visibility", "visible");
        $("#discount_" + i).css("visibility", "visible");
        $("#discount_p_" + i).css("visibility", "visible");
        $("#price_of_unit_" + i).css("visibility", "visible");


        addNewRow(parseInt(i) + 1, items);
        put_data_on_row(i, items);

        $(".doc_line_select:eq(" + i + ") option:first-child").remove();
      }

      $("#general_discount_amount").val(doc.generalDiscount);
      calculate_total_cost()
      $("#general_discount").val(
        ((doc.generalDiscount*100)/parseInt($("#doc_total_value").text())).toFixed(2)
      );

      var totalAfterTax = parseFloat($("#doc_total_after_tax").html()) || 0;
          

      $(".doc_line_select").change(function () {
        if ($(this).val() != "-") {
          $(this).find("option:first-child").remove();
        }
      });

      function keepOnlySelectedOption(selectId) {
        // Get the select element by its ID

        const selectElement = $("#" + selectId);
        const lastChar = selectId.slice(-1);
        const parent = $(".item_column");
        parent.get(parseInt(lastChar)).append(selectElement.find("option:selected").text());
        selectElement.hide();
      }

      $(document).on("input", ".general_discount", function () {
        discounts(this.id);
      });

      function discounts(id) {
        // Select the element dynamically based on the passed ID
        let element = $("#" + id);

        if (id === "general_discount_amount") {
          let discountAmount = parseFloat(element.val()) || 0;
          let totalCost = totalAfterTax - discountAmount;
          $("#doc_total_cost").html(totalCost.toFixed(2));
          alert(element.val())
          let discountPercentage = (discountAmount / totalAfterTax) * 100;
          alert(discountPercentage)
          $("#general_discount").val(discountPercentage.toFixed(2));
        } else if (id === "general_discount") {
          let discountPercentage = parseFloat(element.val()) || 0;
          let discountAmount = totalAfterTax * (discountPercentage / 100);
          $("#general_discount_amount").val(discountAmount.toFixed(2));

          let totalCost = totalAfterTax - discountAmount;
          $("#doc_total_cost").html(totalCost.toFixed(2));
        }
      }

      $(document).on("input", ".input", function () {
        var index = $(this).closest("tr").index();
        var quantity = $("#quantity_" + index).val();
        var price_of_unit = $("#price_of_unit_" + index).val();

        if ($(this).attr("id") == "discount_" + index) {
          $("#discount_p_" + index).val(((100 * $("#discount_" + index).val()) / (quantity * price_of_unit)).toFixed(2));
        } else {
          $("#discount_" + index).val((quantity * price_of_unit * ($("#discount_p_" + index).val() / 100)).toFixed(2));
        }

        calculate_row_prices(index);
      });

      function allow_submit() {
        var inputs = $(".input");

        // Loop through each input to check if it's empty
        inputs.each(function () {
          if ($(this).val() === "") {
            $(this).val("0"); // Set empty inputs to 0
          }
        });
      }

      function removeRow(index, submit) {
        $("#row" + index).remove();

        // Update row indices
        $("#doc_table tbody tr").each(function (i) {
          $(this).attr("id", "row" + i);
          $(this)
            .find("td:first")
            .text(i + 1);
          $(this)
            .find(".remove_row")
            .attr("onclick", "removeRow(" + i + ")");
          $(this)
            .find("#discount_" + i)
            .attr("id", "discount_" + i);
          $(this)
            .find("#price_of_unit_" + i)
            .attr("id", "price_of_unit_" + i);
          $(this)
            .find("#total_price_of_line_" + i)
            .attr("id", "total_price_of_line_" + i);
        });

        calculate_total_cost();
        if (!submit) {
          $("#num_of_rows").val($("#num_of_rows").val() - 1);
        }
        allow_submit();
      }

      $(document).on("click", ".remove_row", function () {
        removeRow($(this).closest("tr").index(), false);
      });

      $(document).on("change", ".doc_line_select", function () {
        var index = $(this).closest("tr").index();
        if ($(".doc_line_select").eq(index).val() != "-") {
          $(".remove_row").eq(index).prop("disabled", false);

          $("#quantity_" + index).css("visibility", "visible");
          $("#tax_" + index).css("visibility", "visible");
          $("#discount_" + index).css("visibility", "visible");
          $("#discount_p_" + index).css("visibility", "visible");
          $("#price_of_unit_" + index).css("visibility", "visible");

          put_data_on_row(index, items);

          if ($(this).closest("tr").is(":last-child")) {
            addNewRow(index + 1, items);
          }
        } else {
          removeRow(index, false);
        }
      });

      function get_item_index_from_id(index) {
        for (let i = 0; i < items.length; i++) {
          if (items[i]._id == $(".doc_line_select").eq(index).val()) {
            return i;
          }
        }
      }

      $(document).on("change", ".doc_line_select", function () {
        var index = $(this).closest("tr").index();
        if ($(".doc_line_select").eq(index).val() != "-") {
          $(".remove_row").eq(index).prop("disabled", false);

          $("#quantity_" + index).css("visibility", "visible");
          $("#tax_" + index).css("visibility", "visible");
          $("#discount_" + index).css("visibility", "visible");
          $("#discount_p_" + index).css("visibility", "visible");
          $("#price_of_unit_" + index).css("visibility", "visible");

          put_data_on_row(index, items);

          if ($(this).closest("tr").is(":last-child")) {
            addNewRow(index + 1);
          }
        } else {
          removeRow(index, false);
        }
      });

      $("#transforms_btn").click(function(event){
        $("body").css("overflow", "hidden");
        $(window).scrollTop(0);
        $("#transforms_to_div").show();
      });

      $("#close_transforms_to_div").click(function(event){
        $("body").css("overflow", "auto");
        $("#transforms_to_div").hide();
      });

      $(".transforms_to_btn").click(function(event){
        $("#transforms_to_div_main_input").val($(this).attr('id'));
        $("#transform_doc").submit()
      });

      $('.doc_history_point_doc_data').click(function(event){
        window.location = '/view?type=docs&id='+$(this).attr('id')+'&type2='+params.get('type2')
      })

      $('#save_btn').click(function(){
        $('#create_doc_form').submit();
      })
    
    });
  </script>
</html>
