<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View</title>
    <!--ajax-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <!--CSS-->
    <link rel="stylesheet" href="general_css.css" />
    <link rel="stylesheet" href="view_css.css" />
    <link rel="stylesheet" href="my_company_css.css" />
    <link rel="stylesheet" href="time_table_css.css" />
    <link rel="stylesheet" href="list_css.css" />
    <link rel="stylesheet" href="fonts_css.css">
    <link rel="stylesheet" href="textarea_css.css">
    <!--Fonts-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Asap+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <!--Header-->
    <%- include('../partials/header'); %>
  </head>

  <body>
    
    <div class="has_sidebar asap-condensed-regular">
      <%- include('../partials/sidebar'); %>
      <div>
        <h1 class="asap-condensed-extralight">View</h1>
        <form action="/view" method="POST" id="view_form" class="glass_efect_2">
          <% if (isParamsEmpty) { %>
          <div>ERROR: No elements selected</div>
          <% } else { %> <% titles.forEach(function(title, index) { %>
          <div>
            <%if(type[index] == 0){%> <%= title %>
            <input name="input<%= index %>" id="<%= title %>" value="<%= data[index] %>" readonly />
            <% }else if(type[index] == 2){ %>
            <button id="turn_to_btn">Turn To</button>
            <div>Total Value : <span id="doc_total_value">0.00</span> €</div>
            <div>Total Discounts : <span id="doc_total_disc">0.00</span> €</div>
            <div>
              Total Price after Discounts :
              <span id="doc_total_after_disc">0.00</span> €
            </div>
            <div>
              Total Price after Tax :
              <span id="doc_total_after_tax">0.00</span> €
            </div>
            <br />

            <div>
              Discount :<br>
              <input id="general_discount" class="general_discount input_type_2 my_width" name="general_discount" type="number" value="0" min="0" max="100" required />
              %
            </div>
            <div>
              Discount Amount:<br>
              <input id="general_discount_amount" class="general_discount input_type_2 my_width" name="general_discount_amount" type="number" value="0" min="0" required />
              €
            </div>

            <div>Total Cost : <span id="doc_total_cost">0.00</span> €</div>
            <br />

            <input id="num_of_rows" name="num_of_rows" style="display: none" />
            <table id="doc_table" class="box_shadow_1">
              <thead>
                <tr>
                  <th class="view_column">A/A</th>
                  <th class="view_column">Title</th>
                  <th class="view_column">Qty</th>
                  <th class="view_column">Tax</th>
                  <th class="view_column">Discount</th>
                  <th class="view_column">Discount %</th>
                  <th class="view_column">U/P</th>
                  <th class="view_column">Value</th>
                  <th class="view_column">Price After Discount</th>
                  <th class="view_column">Final Price</th>
                  <th class="view_column"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <% }else if(type[index] == 3){ %>
            <input name="input<%= index %>" id="<%= title %>" value="<%= data[index] %>" style="display: none" />
            <% }else if(type[index] == 4){ %> <%= title%>
              <input type="checkbox" id="<%= title %>" onclick="return false;" <%= data[index] == 1 ? 'checked' : '' %> />
            <% }else if(type[index] == 5){ %> <%= title %>
            <input name="input<%= index %>" id="<%= title %>" value="<%= data[index] %>" style="display: none" />
            <input type="checkbox" id="<%= title %>_checkbox_<%= index %>" <% if (data[index] == 1) { %> checked <% } %> onclick="document.getElementById('<%= title %>').value = this.checked ? '1' : '0';">
            <% }else if(type[index] == 6){ %>
              <%= title %><br>
              <input name="input<%= index %>" id="<%= title %>" value="<%= data[index] %>" type="number" class="input_type_2 my_width"/>
            <% }else if(type[index] == 7){ %>
              <%= data[index] == 1 ? 'Retail' : 'Wholesale' %><input name="input<%= index %>" id="wholesale_retail" value="<%= data[index] %>" style="display: none;" />
            <% }else if(type[index] == 8){ %>
            <table>
              <thead>
                <tr>
                  <th>A/A</th>
                  <th>Title</th>
                  <th>Count</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% data[index].forEach(function(row, index) { %>
                <tr>
                  <td><%= index +1 %></td>
                  <td><%= row.title %></td>
                  <td><%= row.count %></td>
                  <th>
                    <button id="<%= row.id %>" class="go_to_btn">go</button>
                  </th>
                </tr>
                <%}) %>
              </tbody>
            </table>
            <% }else if(type[index] == 9){ %>
              <br><div><%= title %></div>
            <div class="textarea_container">
              <textarea name="input<%= index %>" id="<%= title %>"><%= data[index] %></textarea>
            </div>
            <% }else if(type[index] == 10){ %>
              
              <div id="nodes_conainer">
                <% data[index].forEach(function(node, index) {%>
                <div>
                  <div class="message_header">
                    <div class="person"><%=node.sender.firstName%> <%=node.sender.lastName%></div>
                    <div class="reg_d"><%=node.registrationDate%></div>
                  </div>
                  
                  <div class="node_text"><%=node.text%></div>
                  
                    <% if (index === data.length - 1) { %>
                      <div class="node_status"><%=node.status%></div>
                    <% } %>
                </div>
                <%});%>
              </div>
              
            <% }else if(type[index] == 11){ %>
            <div>
              <img src="<%= data[index] %>" id="company_logo" />
            </div>
            <% }else if(type[index] == 12){ %>
              <div>
                <% data[index].forEach(function(s, index) {%>
                  <div><input type="checkbox" id="<%= s._id%>" class="series_transforms_check"><%= s.acronym%> - <%= s.title%></div>
                <%});%>
                <input type="text" id="series_transforms_list" name="series_transforms_list" style="display: none;">
              </div>
            <% }else if(type[index] == 13){ %>
            <div id="<%= title %>"><%= title %> : <%= data[index] %></div>
            <% }else if(type[index] == 14){ %>
              <%= title %> : <select id="select_warehose" name="select_warehose"></select>
            <% }else if(type[index] == 15){ %>
                <%= title %> <%= data[index] == 1 ? ' : Active' : data[index] == 0 ? ' : Disabled' : data[index] == 2 ? ' : Deleted' : '' %>
                <input name="input<%= index %>" id="<%= title %>" value="<%= data[index] %>" style="display: none" />

            <% }else{ %> <%= title %>
            <input name="input<%= index %>" id="<%= title %>" class="input_type_2" value="<%= data[index] %>" />
            <% }%>
          </div>
          <% }); %> <% } %>
          <input type="text" name="action" id="action" style="display: none" />
          <div id="button_container">
            <button type="button" class="asap-condensed-regular" id="btn2"></button>
            <button class="asap-condensed-regular" id="btn3">Save</button>
          </div>
          

          <div style="display: none;">
            <input name="day_data_input_user_id" id="day_data_input_user_id" />
            <input name="day_data_input_node_id" id="day_data_input_node_id" />
            <input name="calendar_view_selection" id="calendar_view_selection" />

            From : 
            <input type="date" name="day_data_input_date" id="day_data_input_date"/>
            To : 
            <input type="date" name="day_data_input_date_to" id="day_data_input_date_to" />

            <input name="time_table_hours_start" id="time_table_hours_start" type="number" max="23" min="0"/>
            :
            <input  name="time_table_minutes_start" id="time_table_minutes_start" type="number" max="59" min="0" />

            To
            <input name="time_table_hours_end" id="time_table_hours_end" type="number" max="23" min="0" />
            :
            <input name="time_table_minutes_end" id="time_table_minutes_end" type="number" max="59" min="0" />

            <input name="time_table_notes" type="text" id="time_table_notes">
          </div>

        </form>
        <!--div id="message_div">Record has been deleted</div-->
        <button class="asap-condensed-regular delete_btn" id="btn1">Delete</button>
        
        <div id="clients">
          <button>ΦΠΑ</button>
          <button id="time_table_btn">Time Table</button>
          <div id="time_table_div">
            
            <div id="calendar_div" class="asap-condensed-regular glass_efect_1">
              <div id="filter_div">
                <button class="calendar_date_reage_btn" id="tt_day">Day</button>
                <button class="calendar_date_reage_btn" id="tt_week">Week</button>
                <button class="calendar_date_reage_btn" id="tt_month">Month</button>
                <input id="day_picker" type="date"/>
                <select id="user_select">
                  <option value="all">All</option>
                </select>
              </div>
              <div id="calendar_header">
                <div id="selected_year"></div>
                <div id="selected_month"></div>
                
              </div>

              <div id="day" class="day now day_date"></div>
              <div id="week" class="week">
                <div class="days">
                  <div class="day week_date"></div>
                  <div class="day week_date"></div>
                  <div class="day week_date"></div>
                  <div class="day week_date"></div>
                  <div class="day week_date"></div>
                  <div class="day week_date"></div>
                  <div class="day week_date"></div>
                </div>
              </div>
              <div id="month" class="month">
                <div class="days">
                  <div class="week">
                    <div class="days">
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                    </div>
                  </div>
                  <div class="week">
                    <div class="days">
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                    </div>
                  </div>
                  <div class="week">
                    <div class="days">
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                    </div>
                  </div>
                  <div class="week">
                    <div class="days">
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                    </div>
                  </div>
                  <div class="week">
                    <div class="days">
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                    </div>
                  </div>
                  <div class="week">
                    <div class="days">
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                      <div class="day month_date"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="secondary_data" style="display: none;">f</div>
        <div id="day_data">
          <div id="day_data_header">
            <div>
              <img id="close_btn" src="x.svg"/>
            </div>
            <div id="day_data_date_time">
              <div> 
                <input type="date" class="dummy asap-condensed-regular"/> <input type="date" class="dummy asap-condensed-regular" />
    
              </div>
              <div>
                <input class="dummy asap-condensed-regular" type="number" max="23" min="0" placeholder="0"/>
                :
                <input class="dummy" type="number" max="59" min="0" placeholder="0"/>
  
                -
                <input class="dummy" type="number" max="23" min="0" placeholder="0"/>
                :
                <input class="dummy" type="number" max="59" min="0" placeholder="0"/>
              </div>
            </div>
          </div>


          <div id="day_data_body">
            <div id="day_data_users">
              <div>All <input class="all_selected_users" type="checkbox" value="all"></div>
            </div>
            <div>
              <input id="new_edit_time_teble" name="new_edit_time_teble" style="display: none" />
              <label for="time_table_notes">Notes</label><br />
              <div id="textarea_conatainer">
                <textarea class="dummy" placeholder="Notes..."></textarea>
              </div>
              
            </div>
          </div>
          <div id="day_data_footer">
            <div>
              <button id="delete_event" type="button">Delete</button>
            </div>
            <div>
              <button id="time_table_submit_btn">Submit</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript" src="JSFrontEndFunctions.js"></script>
  <script type="text/javascript" src="JSCalendarFunctions.js"></script>
  <script type="text/javascript" src="JSDocumentFunctions.js"></script>


  <script>
    $(document).ready(function () {
      var selected_date = get_today();
      var calendar_spectrum = "-";
      var clients_users = [];

      const secondary_data = JSON.parse(`<%- JSON.stringify(secondary_data) %>`);

      if($("#Title").text() == "Title : "){
        $("#Title").hide()
      }

      $("#clients").hide();
      $("#message_div").hide();
      //$("#day_data_users").hide();

      $("#day").hide();
      $("#week").hide();
      $("#month").hide();

      $("#day_picker").hide();
      $("#month_picker_month").hide();
      $("#month_picker").hide();

      $("#time_table_div").hide();

      $("#day_data").hide();

      const params = new URLSearchParams(window.location.search);
      var queryParams = {};
      for (const [key, value] of params.entries()) {
        queryParams[key] = value;
      }

      let formAction = "/view";
      if (queryParams.type) {
        formAction += "?type=" + encodeURIComponent(queryParams.type);
      }
      if (queryParams.id) {
        formAction += (queryParams.type ? "&" : "?") + "id=" + encodeURIComponent(queryParams.id);
      }
      if (queryParams.timetable) {
        $("#calendar_view_selection").val(queryParams.timetable);
        $("#tt_"+queryParams.timetable).addClass("selected")
      }
      $("#view_form").attr("action", formAction);

      var delete_deactivate = $("#Status").val();
      var btn_1_var = "activate";
      if (delete_deactivate == 0) {
        $("#btn2").text("Activate");
      } else if (delete_deactivate == 1) {
        $("#btn2").text("Disable");
        var btn_1_var = "disabled";
      } else if (delete_deactivate == 2) {
        $("#btn1").hide();
        //$("#btn2").hide();
        $("#btn2").text("Activate");
        $("#btn3").hide();
        $("#message_div").show();
        $("#message_span").text(queryParams.type);
      }

      if (queryParams.type == "docs") {
        $("#btn2").hide();

        if (secondary_data.warehouse._id == "-") {
          $("#select_warehose").append(`<option value="-">-</option>`);
        }
        for (w of secondary_data.warehouses) {
          $("#select_warehose").append(`<option value="${w._id}">${w.title}</option>`);
        }
        if (secondary_data.warehouse._id != "-") {
          $("#select_warehose").val(secondary_data.warehouse._id);
        }


        var selected_items = JSON.parse(`<%- JSON.stringify(data) %>`)[8];
        var items = JSON.parse(`<%- JSON.stringify(data) %>`)[9];
        console.log(items)
        console.log("-----------")

        addNewRow(0, items);

        for (i in selected_items) {
          $(".doc_line_select:eq(" + i + ') option[value="' + selected_items[i].lineItem + '"]').prop("selected", true);

          put_data_on_row(0, items);
          let quantity = selected_items[i].quantity;
          let price_of_unit = selected_items[i].price_of_unit;
          let total = quantity * price_of_unit;
          let tax = selected_items[i].tax;
          let totalAfterTax = total + total * (tax / 100);
          let discount = selected_items[i].discount;
          let discount_p = ((discount / total) * 100).toFixed(2);

          $("#quantity_" + i).val(quantity);
          $("#tax_" + i).val(tax);
          $("#discount_" + i).val(discount);
          $("#discount_p_" + i).val(discount_p);
          $("#price_of_unit_" + i).val(price_of_unit);
          $("#total_price_of_line_" + i).text(total);
          $("#total_price_of_line_after_disc_" + i).text(total - discount);
          $("#final_price_of_line_" + i).text(total - discount + (total - discount) * (tax / 100));

          $(".remove_row").eq(i).prop("disabled", false);

          $("#quantity_" + i).css("visibility", "visible");
          $("#tax_" + i).css("visibility", "visible");
          $("#discount_" + i).css("visibility", "visible");
          $("#discount_p_" + i).css("visibility", "visible");
          $("#price_of_unit_" + i).css("visibility", "visible");

          if ($("#Sealed").is(":checked")) {
            $(".input").val(quantity).prop("readonly", true);
            keepOnlySelectedOption("doc_line_item_" + i);

            if (i < Object.keys(selected_items).length - 1) {
              addNewRow(parseInt(i) + 1, items);
            }
          } else {
            addNewRow(parseInt(i) + 1, items);
          }
         
          $(".doc_line_select:eq(" + i + ") option:first-child").remove();
        }

        $(".doc_line_select").change(function () {
          if ($(this).val() != "-") {
            $(this).find("option:first-child").remove();
          }
        });

        function keepOnlySelectedOption(selectId) {
          // Get the select element by its ID
          

          const selectElement = $("#"+selectId);
          const lastChar = selectId.slice(-1);
          const parent = $(".item_column");
          parent.get(parseInt(lastChar)).append(selectElement.find("option:selected").text());
            selectElement.hide()
           
          /*// Check if the select element exists
          if (selectElement) {
            const selectedValue = selectElement.val(); // Get the value of the selected option
            const selectedText = selectElement.find("option:selected").text(); // Get the text of the selected option

            selectElement.empty(); // Remove all options

            // Add back only the selected option
            selectElement.append("<option value='1'>" + selectedText + "</option>");
          }*/
        }

        $(document).on("input", ".general_discount", function () {
          let totalAfterTax = parseFloat($("#doc_total_after_tax").html()) || 0;

          if ($(this).attr("id") === "general_discount_amount") {
            let discountAmount = parseFloat($(this).val()) || 0;
            let totalCost = totalAfterTax - discountAmount;
            $("#doc_total_cost").html(totalCost.toFixed(2));

            let discountPercentage = (discountAmount / totalAfterTax) * 100;
            $("#general_discount").val(discountPercentage.toFixed(2));
          } else {
            let discountPercentage = parseFloat($(this).val()) || 0;
            let discountAmount = totalAfterTax * (discountPercentage / 100);
            $("#general_discount_amount").val(discountAmount.toFixed(2));

            let totalCost = totalAfterTax - discountAmount;
            $("#doc_total_cost").html(totalCost.toFixed(2));
          }
        });

        $(document).on("input", ".input", function () {
          var index = $(this).closest("tr").index();
          var quantity = $("#quantity_" + index).val();
          var price_of_unit = $("#price_of_unit_" + index).val();

          if ($(this).attr("id") == "discount_" + index) {
            $("#discount_p_" + index).val(((100 * $("#discount_" + index).val()) / (quantity * price_of_unit)).toFixed(2));
          } else {
            $("#discount_" + index).val((quantity * price_of_unit * ($("#discount_p_" + index).val() / 100)).toFixed(2));
          }

          calculate_row_prices(index);
        });

        function allow_submit() {
          var inputs = $(".input");

          // Loop through each input to check if it's empty
          inputs.each(function () {
            if ($(this).val() === "") {
              $(this).val("0"); // Set empty inputs to 0
            }
          });
        }

        function removeRow(index, submit) {
          $("#row" + index).remove();

          // Update row indices
          $("#doc_table tbody tr").each(function (i) {
            $(this).attr("id", "row" + i);
            $(this)
              .find("td:first")
              .text(i + 1);
            $(this)
              .find(".remove_row")
              .attr("onclick", "removeRow(" + i + ")");
            $(this)
              .find("#discount_" + i)
              .attr("id", "discount_" + i);
            $(this)
              .find("#price_of_unit_" + i)
              .attr("id", "price_of_unit_" + i);
            $(this)
              .find("#total_price_of_line_" + i)
              .attr("id", "total_price_of_line_" + i);
          });

          calculate_total_cost();
          if (!submit) {
            $("#num_of_rows").val($("#num_of_rows").val() - 1);
          }
          allow_submit();
        }

        $(document).on("click", ".remove_row", function () {
          removeRow($(this).closest("tr").index(), false);
        });

        
        $(document).on("change", ".doc_line_select", function () {
          var index = $(this).closest("tr").index();
          if ($(".doc_line_select").eq(index).val() != "-") {
            $(".remove_row").eq(index).prop("disabled", false);

            $("#quantity_" + index).css("visibility", "visible");
            $("#tax_" + index).css("visibility", "visible");
            $("#discount_" + index).css("visibility", "visible");
            $("#discount_p_" + index).css("visibility", "visible");
            $("#price_of_unit_" + index).css("visibility", "visible");

            put_data_on_row(index, items);

            if ($(this).closest("tr").is(":last-child")) {
              addNewRow(index + 1, items);
            }
          } else {
            removeRow(index, false);
          }
        });

        function get_item_index_from_id(index) {
          for (let i = 0; i < items.length; i++) {
            if (items[i]._id == $(".doc_line_select").eq(index).val()) {
              return i;
            }
          }
        }

        $(document).on("change", ".doc_line_select", function () {
          var index = $(this).closest("tr").index();
          if ($(".doc_line_select").eq(index).val() != "-") {
            $(".remove_row").eq(index).prop("disabled", false);

            $("#quantity_" + index).css("visibility", "visible");
            $("#tax_" + index).css("visibility", "visible");
            $("#discount_" + index).css("visibility", "visible");
            $("#discount_p_" + index).css("visibility", "visible");
            $("#price_of_unit_" + index).css("visibility", "visible");

            put_data_on_row(index, items);

            if ($(this).closest("tr").is(":last-child")) {
              addNewRow(index + 1);
            }
          } else {
            removeRow(index, false);
          }
        });

        $("#btn3").click(function () {
          event.preventDefault();
          $("#action").val("save");
          $("#view_form").submit();
        });
      }
      else if (queryParams.type == "nodes") {
        $("#Type").css('text-align', 'center');
        $("#Type").text($("#Type").text().replace("Type : ", ""));
        if($("#Type").text()=="Hiring"){
          $("#Title").hide()
          $("#nodes_conainer").hide()
          $(".textarea_container").parent().hide();
          $("#btn3").text('Accept');
          $("#btn2").text('Accept')
        }
        else{
          $("#btn3").text("Ececute");
        }
        var node = $(".node_status:last");

        if (node.text() == "2") {
          $("#btn1").prop("disabled", true);
        } else if (node.text() == "4") {
          $("#btn1").prop("disabled", true);
          $("#btn2").prop("disabled", true);
        }

        $("#btn1").hide();

        
        $("#btn3").click(function () {
          $("#action").val("executed");
          $("#view_form").submit();
        });
        $("#btn2").text("Reject");
        $("#btn2").css("background-color", "red");
        $("#btn2").click(function () {
          event.preventDefault();
          $("#action").val("rejected");
          $("#view_form").submit();
        });
      }
      else if (queryParams.type == "clients") {
        clients_users = secondary_data.users;

        for (client of clients_users) {
          $("#user_select").append(`<option value="${client._id}">${client.firstName} ${client.lastName}</option>`);
          $("#day_data_users").append(`<div>${client.firstName} ${client.lastName} <input class="all_selected_users" type="checkbox" value="${client._id}"></div>`);

        }
        $("#clients").show();

        if (queryParams.timetable) {
          show_hide_time_table();
          show_calendar(queryParams.timetable);
        }

        if (queryParams.timetable_user) {
          $("#user_select").val(queryParams.timetable_user);
        } else {
          $("#user_select").val("all");
        }

        $("#btn2").text("Remove");
        $("#btn2").click(function(event){
          event.preventDefault();
          alert("Remove Client")});
      }
      else if (queryParams.type == "reports"){
        $("#btn1").hide()
        $("#btn2").hide()
        $("#btn3").hide()
      }
      else {
        $("#btn1").click(function () {
          event.preventDefault();
          if (confirm("Are you soure ?")) {
            $("#action").val("delete");
            $("#view_form").submit();
          }
        });
        $("#btn2").click(function () {
          event.preventDefault();
          $("#action").val(btn_1_var);
          //$("#view_form").submit();
        });
        $("#btn3").click(function () {
          event.preventDefault();
          $("#action").val("save");
          $("#view_form").submit();
        });
      }
      
      /*$("#btn3").click(function () {
        if(){}
      });*/

      if (queryParams.type == "series") {
        for( s of secondary_data.selected_series){
          $("#" + s).prop("checked", true);
          $('#series_transforms_list').val($('#series_transforms_list').val()+','+s)
        }
      }

      function calculate_total(class_id, target_id) {
        var tottal = 0;
        var lines_tottal = $("." + class_id);

        lines_tottal.each(function () {
          var value = parseFloat($(this).text()) || parseFloat($(this).val()) || 0;
          tottal += value;
        });
        $("#" + target_id).text(tottal.toFixed(2)); // Optionally format to 2 decimal places
      }

      $(".go_to_btn").click(function () {
        event.preventDefault();
        var url_page, url_type, url_id;
        if (queryParams.type == "Warehouse") {
          url_page = "items";
          url_id = $(this).attr("id");
        }
        window.location = "/view?type=" + url_page + "&id=" + url_id;
      });

      $(".calendar_date_reage_btn").click(function () {
        let type = $(this).attr("id").replace("tt_", "");
        day_week_month(type);
      });

      $("#user_select").change(function () {
        window.location = "/view?type=clients&id=" + queryParams.id + "&timetable=" + queryParams.timetable + "&timetable_user=" + $("#user_select").val();
      });

      function day_week_month(input) {
        window.location = "/view?type=clients&id=" + queryParams.id + "&timetable=" + input + "&timetable_user=" + $("#user_select").val();
      }

      function show_calendar(input) {
        if (input == "month") {
          $("#day").hide();
          $("#week").hide();
          $("#month").show();
        } else if (input == "week") {
          $("#day").hide();
          $("#week").show();
          $("#month").hide();
        } else if (input == "day") {
          $("#day").show();
          $("#week").hide();
          $("#month").hide();

          $("#day_picker").show();
        }

        $("#day_picker").show();
        $("#day_picker").val(selected_date);
        calendar_spectrum = input;
        pick_date();

        put_data_on_calendar("all");
      }

      $("#time_table_btn").click(function () {
        show_hide_time_table();
      });

      function show_hide_time_table() {
        if (queryParams.timetable) {
          $("#time_table_div").toggle();
        }
        else{
          day_week_month('month')
        }
        
        //$("#date_from").val(selected_date);
        $("#day_picker").val(selected_date);
      }

      function pick_date() {
        selected_date = $("#day_picker").val();
        show_selected_month_year(selected_date);
        put_dates(calendar_spectrum, $("#day_picker").val());
      }

      $("#close_btn").click(function (event) {
        event.preventDefault();
        $("#day_data").hide();
      });

      $("#time_table_submit_btn").click(function (event) {
        event.preventDefault();
        let c_e_o = check_event_overlap($("#day_data_input_user_id").val(), $("#day_data_input_date").val(), $("#time_table_hours_start").val(), $("#time_table_minutes_start").val(), $("#time_table_hours_end").val(), $("#time_table_minutes_end").val(), secondary_data.nodes);
        $("#action").val("time_table");
        if (c_e_o == 0 && $('#day_data_input_node_id').val()=='') {
          if(confirm("This time overlaps with enother event")){
            if(confirm("This will replace existing with new are you sure ?")){
              $("#view_form").submit();
            }
          }
        }
        else if(
          ($("#day_data_input_user_id").val() == 'all' ||
          $("#day_data_input_user_id").val() == '' ||
          $("#day_data_input_date").val() == '' ||
          $("#day_data_input_date_to").val() == '' ||
          $("#time_table_hours_start").val() == '' ||
          $("#time_table_minutes_start").val() == '' ||
          $("#time_table_hours_end").val() == '' ||
          $("#time_table_minutes_end").val() == '')&&
          $('#day_data_input_node_id').val()==''
        ){
          alert("missing data")
        }
        else {
          $("#view_form").submit();
        }
      });

      $("#delete_event").click(function (event) {
        event.preventDefault();
        $("#action").val("time_table_delete");
        $("#view_form").submit();
      });

      function show_selected_month_year(date) {
        $("#selected_month").text(date.split("-")[1]);
        $("#selected_year").text(date.split("-")[0]);
      }

      function put_data_on_calendar(user) {
        var days = $(".day.now");
        var selected_month = $("#selected_month").text();
        var selected_year = $("#selected_year").text();
        var cal_days = [];
        var selected_user = "all";
        if (queryParams.timetable_user) {
          selected_user = queryParams.timetable_user;
        }

        days.each(function (index, element) {
          cal_days.push(parseInt($(element).text()));
        });
        for (n of secondary_data.nodes) {
          if (selected_year == new Date(n.data.date).getFullYear()) {
        if (selected_month == new Date(n.data.date).getMonth() + 1) {
          if (cal_days.includes(new Date(n.data.date).getDate())) {
            const index = cal_days.findIndex((day) => day === new Date(n.data.date).getDate());
            // Get the events container div inside the selected day element
            var eventsContainer = $(days[index]).find(".events_container");
            if (selected_user == n.user._id || selected_user == "all") {
            var day_div = "<div class='day_line' id='" + n._id + "'>" + "<div class=event_id style='display:none'>" + n.user._id + "</div>" + "<div>" + n.user.firstName + " " + n.user.lastName + "</div>" + "<div>" + (n.data.hour_start < 10 ? '0' : '') + n.data.hour_start + " : " + (n.data.minutes_start < 10 ? '0' : '') + n.data.minutes_start + " - " + (n.data.hour_end < 10 ? '0' : '') + n.data.hour_end + " : " + (n.data.minutes_end < 10 ? '0' : '') + n.data.minutes_end + "</div>";
          if(n.text){
            day_div = day_div + "<div> Notes : <br>" + n.text + "</div>";
          }
          
          day_div = day_div + "</div>"

          eventsContainer.append(day_div);
            }
          }
        }
          }
        }
        // Add class 'today' if date matches today
        var today = new Date();
        days.each(function (index, element) {
          var day = parseInt($(element).text());
          var month = parseInt(selected_month);
          var year = parseInt(selected_year);
          if (day === today.getDate() && month === (today.getMonth() + 1) && year === today.getFullYear()) {
        $(element).addClass("today");
          }
        });
      }

      $("#day_picker").change(function () {
        pick_date();
      });

      $(".day_line").click(function (event) {
        event.stopPropagation();
        //$("#day_data_users").hide();
        view_edit_event($(this).attr("id"), secondary_data.nodes,secondary_data.users);
        $('.dummy').eq(1).hide();
      });

      $("#time_table_hours_end").on("blur", function () {
        let start = $("#time_table_hours_start").val();
        if ($("#time_table_hours_end").val() < start) {
          alert("time_table_hours_start < time_table_hours_end");
          $("#time_table_hours_end").val(parseInt(start) + 1);
        }
      });

      $(".all_selected_users").change(function (event){
        var checkboxes = $('.all_selected_users');

        if($(this).val() == 'all'){
          var set_value = false;
          if($(this).prop('checked')){
            set_value = true;
          }
          for( c of checkboxes){
            $(c).prop('checked', set_value);
          }
        }

        var selected_users =''
        for( c of checkboxes){
          if($(c).prop('checked') == true){
            selected_users=selected_users + $(c).val()+";"
          }
        }
        selected_users = selected_users.replace('all;', '').slice(0, -1);;
        $('#day_data_input_user_id').val(selected_users);
        
      });

      $(".dummy").change(function (event) {
        const dummys = $(".dummy");  
        $("#day_data_input_date").val(dummys.eq(0).val());
        $("#day_data_input_date_to").val(dummys.eq(1).val());

        var start = { hour: parseInt(dummys.eq(2).val(), 10), minutes: parseInt(dummys.eq(3).val(), 10) };

        if (!start.hour) start.hour = 0;
        if (!start.minutes) start.minutes = 0;

        dummys.eq(2).val(start.hour);
        dummys.eq(3).val(start.minutes);

        var end = { hour: parseInt(dummys.eq(4).val(), 10), minutes: parseInt(dummys.eq(5).val(), 10) };

        if (!end.hour) end.hour = 0;
        if (!end.minutes) end.minutes = 0;

        let total_start = start.hour * 60 + start.minutes;
        let total_end = end.hour * 60 + end.minutes;


        if (total_end <= total_start) {
          end.hour = start.hour + 1
          end.minutes = 0;
        }

        dummys.eq(4).val(end.hour)
        dummys.eq(5).val(end.minutes)

        $("#time_table_hours_start").val(start.hour)
        $("#time_table_minutes_start").val(start.hour)
        $("#time_table_hours_end").val(end.hour)
        $("#time_table_minutes_end").val(end.minutes)
        $("#time_table_notes").val(dummys.eq(6).val())      
      });

      function check_event_overlap(id, date, s_hour, s_min, e_hour, e_min, nodes) {
        // Convert input start and end times to minutes since midnight
        const inputStartTime = parseInt(s_hour) * 60 + parseInt(s_min);
        const inputEndTime = parseInt(e_hour) * 60 + parseInt(e_min);

        var isDateMatching = false;
        var isTimeOverlapping = false;

        for (node of nodes) {
          const nodeDate = formatDate(new Date(node.data.date));
          const nodeStartTime = parseInt(node.data.hour_start) * 60 + parseInt(node.data.minutes_start);
          const nodeEndTime = parseInt(node.data.hour_end) * 60 + parseInt(node.data.minutes_end);

          //id
          isIdMatching = node.user._id == id;

          //date
          isDateMatching = nodeDate == formatDate(new Date(date));

          //time
          if (inputStartTime >= nodeStartTime && inputStartTime < nodeEndTime) {
            isTimeOverlapping = true;
          } else if (inputStartTime < nodeStartTime && inputEndTime <= nodeEndTime) {
            isTimeOverlapping = true;
          } else if (inputEndTime < nodeEndTime) {
            isTimeOverlapping = true;
          }

          if (isIdMatching && isTimeOverlapping && isDateMatching){
            return 0;
          }
        }
        return 1;
      }

      $('.series_transforms_check').on('change', function(){
        // Get all checked checkboxes and map their values (IDs) into an array
        const checkedIds = $('.series_transforms_check:checked').map(function () {
          return $(this).attr('id').replace(/'/g, "");
        }).get(); // Convert the jQuery object to an array

        // Update the input field with a comma-separated list of IDs
        $('#series_transforms_list').val(checkedIds.join(','));
      });

      $("#turn_to_btn").click(function () {
        secondary_data_f();
        });

      $(".day.now").click(function(event){
        let user_id = $("#user_select").val();
        $("#day_data_users").show();


        // Generate the date string
        let year = $("#selected_year").text();
        let month = $("#selected_month").text().padStart(2, "0");
        let day = $(this).attr("id").replace("add_event_for_", "").padStart(2, "0");
        let date = `${year}-${month}-${day}`;

        new_event($(this).attr("id"), secondary_data.nodes, date, user_id);
      })

      function secondary_data_f(){
        alert('secondary_data');
      }
    });
  </script>
</html>
